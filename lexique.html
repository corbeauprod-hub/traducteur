<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Traducteur Elfique Complet</title>
<style>
body {background:#1a1a2e; color:#e0e0f8; font-family: 'Trebuchet MS', sans-serif; padding:20px;}
textarea, input, button {width:100%; margin:5px 0; font-size:1em;}
button {background:#162447; color:#f0f0f0; border:none; padding:10px; cursor:pointer;}
button:hover {background:#1f4068;}
#outputText {font-weight:bold;}
</style>
</head>
<body>

<h1>Traducteur Elfique</h1>
<textarea id="inputText" rows="3" placeholder="Phrase française"></textarea>
<button id="translateBtn">Traduire</button>
<p>Traduction : <span id="outputText"></span></p>

<h2>Lexique</h2>
<button id="importLexBtn">Importer depuis Google Sheets</button>
<button id="exportLexBtn">Exporter vers Google Sheets</button>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdD3gp_pRGIt5NNQoVkOUh6gP2d6lMD41WZISzQOAsRa_K-Ue1btaQfEBjH61P0bbxPg/exec";

/* 1. Lexique de base */
const lexiqueBase = {
  "nuit":"nar","jour":"ar","blanc":"ar","gris":"gil","argenté":"gilar","noir":"niel","aube":"vanar","or":"gala",
  "brume":"gileth","ténèbres":"nielor","ombre":"lanar","crépuscule":"gilnar",
  "noble": "syl","noblesse": "syldar","prince": "lanasyl","roi": "anasyl","champion": "danasyl",
  "dieu": "valar",
  "je":"mi","tu":"ti","il":"sa","elle":"sa","nous":"men","vous":"ven","ils":"serin","elles":"serin",
  "être":"era","suis":"era","es":"era","est":"era","sommes":"era","êtes":"era","sont":"era",
  "avoir":"vara","ai":"vara","as":"vara","a":"vara","avons":"vara","avez":"vara","ont":"vara",
  "aller":"lira","venir":"qira","faire":"orna","voir":"mirë","dire":"telrë","lever": "velei","tomber": "veniel",
  "espoir":"orea"
};

/* 2. Lexique persistant */
let lexique = {...lexiqueBase, ...JSON.parse(localStorage.getItem("elfiqueLexique")||"{}")};
function sauvegarderLexique(){localStorage.setItem("elfiqueLexique", JSON.stringify(lexique));}

/* 3. Pluriel */
function estPluriel(mot){return mot.endsWith("s")&&!mot.endsWith("us");}
function plurielElfique(mot){return mot.endsWith("in")?mot:mot+"in";}

/* 4. Génération harmonisée */
function genererMotElfique(motFr, syllabesUtilisees, terminaisonsUtilisees){
  const racines=["ar","nar","gil","syl","niel","val","lu","el","lin"];
  const suffixes=["el","en","ion","or","ath","iel","ys","lin","ar","ë"];
  let mot, essais=0;
  do{
    const r=racines[Math.floor(Math.random()*racines.length)];
    const s=suffixes[Math.floor(Math.random()*suffixes.length)];
    mot=r+s;
    essais++;
    if(essais>20) break;
  }while(syllabesUtilisees.has(mot.slice(0,2)) || terminaisonsUtilisees.has(mot.slice(-2)));
  syllabesUtilisees.add(mot.slice(0,2));
  terminaisonsUtilisees.add(mot.slice(-2));
  lexique[motFr]=mot;
  sauvegarderLexique();
  return mot;
}

/* 5. Traduction de phrase */
function traduire(phrase){
  const mots = phrase.toLowerCase().split(/\s+/);
  const resultat=[];
  const syllabesUtilisees=new Set();
  const terminaisonsUtilisees=new Set();

  mots.forEach(mot=>{
    let motBase=lexique[mot];
    if(!motBase){
      motBase = genererMotElfique(mot, syllabesUtilisees, terminaisonsUtilisees);
    }
    // gérer pluriel
    if(estPluriel(mot)) motBase = plurielElfique(motBase);

    resultat.push(motBase);
    syllabesUtilisees.add(motBase.slice(0,2));
    terminaisonsUtilisees.add(motBase.slice(-2));
  });

  return resultat.join(" ");
}

/* 6. Tri lexique alphabétique avec voyelles accentuées */
function trierLexique(lx){
  return Object.fromEntries(
    Object.entries(lx).sort((a,b)=>{
      const aa=a[0].normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const bb=b[0].normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      return aa.localeCompare(bb);
    })
  );
}

/* 7. Export lexique */
async function exportLexique(){
  const fd = new FormData();
  for(const [fr, el] of Object.entries(lexique)) fd.append(fr, el);
  try{
    const resp = await fetch(GOOGLE_SCRIPT_URL, {method:"POST", body:fd});
    const data = await resp.json();
    alert("Lexique exporté !");
  }catch(e){alert("Erreur export : "+e);}
}

/* 8. Import lexique */
async function importLexique(){
  try{
    const resp = await fetch(GOOGLE_SCRIPT_URL);
    const data = await resp.json();
    lexique={};
    data.forEach(item=>lexique[item.fr]=item.el);
    lexique=trierLexique(lexique);
    sauvegarderLexique();
    alert("Lexique importé !");
  }catch(e){alert("Erreur import : "+e);}
}

/* 9. Événements interface */
document.getElementById("translateBtn").addEventListener("click", ()=>{
  const phrase=document.getElementById("inputText").value;
  document.getElementById("outputText").textContent=traduire(phrase);
});
document.getElementById("exportLexBtn").addEventListener("click", exportLexique);
document.getElementById("importLexBtn").addEventListener("click", importLexique);
</script>

</body>
</html>
