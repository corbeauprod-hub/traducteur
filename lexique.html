<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Traducteur Elfique</title>
<style>
body {
  background:#1a1a2e;
  color:#e0e0f8;
  font-family: 'Trebuchet MS', sans-serif;
  padding:20px;
}
h1,h2 {text-shadow: 2px 2px 4px #000;}
textarea,input {width:100%; margin:5px 0; font-size:1em; padding:5px; border-radius:5px;}
button {background:#162447; color:#f0f0f0; border:none; padding:10px; cursor:pointer; border-radius:5px; font-weight:bold;}
button:hover {background:#1f4068;}
#outputText {font-weight:bold; font-size:1.2em; color:#ffd700;}
#lexiqueList {max-height:200px; overflow:auto; border:1px solid #444; padding:5px; background:#111; border-radius:5px;}
#lexiqueList div {padding:2px 0;}
#searchLex {margin-bottom:10px; padding:5px; border-radius:5px;}
</style>
</head>
<body>

<h1>Traducteur Elfique</h1>

<textarea id="inputText" rows="3" placeholder="Phrase française"></textarea>
<button id="translateBtn">Traduire</button>
<p>Traduction : <span id="outputText"></span></p>

<h2>Lexique</h2>
<input type="text" id="searchLex" placeholder="Rechercher dans le lexique...">
<div id="lexiqueList"></div>
<button id="importLexBtn">Importer depuis Google Sheets</button>
<button id="exportLexBtn">Exporter vers Google Sheets</button>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyP3aAHjbHEp-yFcoQrG-O8iEK0nbYm8YWpiW-tUpyBGD65-g3F3qBALGLZPk6-dsccqg/exec";

/* 1. Lexique de base */
const lexiqueBase = {
  "nuit":"nar","jour":"ar","blanc":"ar","gris":"gil","argenté":"gilar","noir":"niel","aube":"vanar","or":"gala",
  "brume":"gileth","ténèbres":"nielor","ombre":"lanar","crépuscule":"gilnar",
  "noble": "syl","noblesse": "syldar","prince": "lanasyl","roi": "anasyl","champion": "danasyl",
  "dieu": "valar",
  "je":"mi","tu":"ti","il":"sa","elle":"sa","nous":"men","vous":"ven","ils":"serin","elles":"serin",
  "être":"era","suis":"era","es":"era","est":"era","sommes":"era","êtes":"era","sont":"era",
  "avoir":"vara","ai":"vara","as":"vara","a":"vara","avons":"vara","avez":"vara","ont":"vara",
  "aller":"lira","venir":"qira","faire":"orna","voir":"mirë","dire":"telrë","lever": "velei","tomber": "veniel",
  "espoir":"orea"
};

/* 2. Lexique persistant */
let lexique = {...lexiqueBase, ...JSON.parse(localStorage.getItem("elfiqueLexique")||"{}")};
function sauvegarderLexique(){localStorage.setItem("elfiqueLexique", JSON.stringify(lexique));}

/* 3. Pluriel */
function estPluriel(mot){return mot.endsWith("s")&&!mot.endsWith("us");}
function plurielElfique(mot){return mot.endsWith("in")?mot:mot+"in";}

/* 4. Génération harmonisée */
function genererMotElfique(motFr, syllabesUtilisees, terminaisonsUtilisees){
  const racines=["ar","nar","gil","syl","niel","val","lu","el","lin"];
  const suffixes=["el","en","ion","or","ath","iel","ys","lin","ar","ë"];
  let mot, essais=0;
  do{
    const r=racines[Math.floor(Math.random()*racines.length)];
    const s=suffixes[Math.floor(Math.random()*suffixes.length)];
    mot=r+s;
    essais++;
    if(essais>20) break;
  }while(syllabesUtilisees.has(mot.slice(0,2)) || terminaisonsUtilisees.has(mot.slice(-2)));
  syllabesUtilisees.add(mot.slice(0,2));
  terminaisonsUtilisees.add(mot.slice(-2));
  lexique[motFr]=mot;
  sauvegarderLexique();
  return mot;
}

/* 5. Traduction de phrase */
function traduire(phrase){
  const mots = phrase.toLowerCase().split(/\s+/);
  const resultat=[];
  const syllabesUtilisees=new Set();
  const terminaisonsUtilisees=new Set();

  mots.forEach(mot=>{
    let motBase=lexique[mot];
    if(!motBase){
      motBase = genererMotElfique(mot, syllabesUtilisees, terminaisonsUtilisees);
    }
    if(estPluriel(mot)) motBase = plurielElfique(motBase);
    resultat.push(motBase);
    syllabesUtilisees.add(motBase.slice(0,2));
    terminaisonsUtilisees.add(motBase.slice(-2));
  });

  return resultat.join(" ");
}

/* 6. Tri lexique alphabétique avec voyelles accentuées */
function trierLexique(lx){
  return Object.fromEntries(
    Object.entries(lx).sort((a,b)=>{
      const aa=a[0].normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      const bb=b[0].normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      return aa.localeCompare(bb);
    })
  );
}

/* 7. Export lexique */
async function exportLexique(){
  const fd = new FormData();
  for(const [fr, el] of Object.entries(lexique)) fd.append(fr, el);
  try{
    const resp = await fetch(GOOGLE_SCRIPT_URL, {method:"POST", body:fd});
    const data = await resp.json();
    alert("Lexique exporté !");
  }catch(e){alert("Erreur export : "+e);}
}

/* 8. Import lexique */
async function importLexique(){
  try{
    const resp = await fetch(GOOGLE_SCRIPT_URL);
    const data = await resp.json();
    lexique={};
    data.forEach(item=>lexique[item.fr]=item.el);
    lexique=trierLexique(lexique);
    sauvegarderLexique();
    afficherLexique();
    alert("Lexique importé !");
  }catch(e){alert("Erreur import : "+e);}
}

/* 9. Affichage lexique + moteur de recherche */
function afficherLexique(filter=""){
  const listDiv = document.getElementById("lexiqueList");
  listDiv.innerHTML="";
  Object.entries(lexique).forEach(([fr, el])=>{
    if(fr.includes(filter) || el.includes(filter)){
      const div = document.createElement("div");
      div.textContent=`${fr} → ${el}`;
      listDiv.appendChild(div);
    }
  });
}

/* 10. Événements interface */
document.getElementById("translateBtn").addEventListener("click", ()=>{
  const phrase=document.getElementById("inputText").value;
  document.getElementById("outputText").textContent=traduire(phrase);
});
document.getElementById("exportLexBtn").addEventListener("click", exportLexique);
document.getElementById("importLexBtn").addEventListener("click", importLexique);
document.getElementById("searchLex").addEventListener("input", e=>{
  afficherLexique(e.target.value.toLowerCase());
});

/* 11. Initialisation */
afficherLexique();
</script>
</body>
</html>
